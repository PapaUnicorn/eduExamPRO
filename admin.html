<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><title>Admin Panel | Edunexus Indonesia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // AUTH GUARD: Hanya Admin yang bisa buka halaman ini
        const u = JSON.parse(localStorage.getItem('userAccount'));
        if(!u || u.privilege !== 'Admin') { 
            alert("Akses Terbatas: Hanya untuk Admin!"); 
            window.location.href="login.html"; 
        }
    </script>
</head>
<body class="bg-slate-100 p-8 font-['Inter']">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Admin Dashboard</h2>
            <button onclick="localStorage.removeItem('userAccount'); window.location.href='index.html'" class="text-red-600 font-bold bg-red-50 px-4 py-2 rounded-xl border border-red-100">Logout Admin</button>
        </div>
        
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <div class="p-6 bg-slate-900 text-white flex justify-between">
                <span class="font-bold">Daftar Member & Manajemen Akses</span>
                <span id="userCount" class="text-indigo-400">Loading data...</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-[11px] uppercase text-slate-500 font-bold">
                            <th class="p-6">Username / Nama</th>
                            <th class="p-6">Password</th>
                            <th class="p-6">Status</th>
                            <th class="p-6">Expiry</th>
                            <th class="p-6">Privilege</th>
                            <th class="p-6">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzv4azWHXvtaX3n1fobQZr8WGzYQ_RhuP8Wda_wxavJ1uOafsKm267E3t-NPZ1E5G_j/exec';
        
        async function load(){
            document.getElementById('userList').innerHTML = '<tr><td colspan="6" class="p-10 text-center animate-pulse">Mengambil data dari server...</td></tr>';
            try {
                const resp = await fetch(scriptURL); 
                const users = await resp.json();
                document.getElementById('userCount').innerText = `${users.length} Total Users`;
                
                document.getElementById('userList').innerHTML = users.map(u => `
                    <tr class="border-b hover:bg-slate-50 transition-colors">
                        <td class="p-6">
                            <div class="font-bold text-slate-900">${u.username}</div>
                            <div class="text-[10px] text-slate-400">${u.nama}</div>
                        </td>
                        <td class="p-6 font-mono text-xs text-indigo-600">${u.pass}</td>
                        <td class="p-6">
                            <span class="px-2 py-1 rounded-md text-[10px] font-bold ${u.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${u.status}</span>
                        </td>
                        <td class="p-6 text-slate-500 text-xs">${u.expiry ? new Date(u.expiry).toLocaleDateString('id-ID') : '-'}</td>
                        <td class="p-6">
                            <select id="p-${u.username}" class="border rounded px-2 py-1 text-xs">
                                <option value="User" ${u.privilege==='User'?'selected':''}>User</option>
                                <option value="Admin" ${u.privilege==='Admin'?'selected':''}>Admin</option>
                            </select>
                        </td>
                        <td class="p-6">
                            <button onclick="upd('${u.username}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow hover:bg-indigo-700">Aktivasi / Save</button>
                        </td>
                    </tr>`).join('');
            } catch (e) { alert("Gagal memuat data."); }
        }

        async function upd(un){
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "...";
            
            // Set expired 1 tahun dari hari ini saat aktivasi
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);

            const data = { 
                action: "updateUser", 
                username: un, 
                privilege: document.getElementById('p-'+un).value, 
                status: "Active", 
                expiry: nextYear.toISOString() 
            };
            
            try {
                await fetch(scriptURL, {method:'POST', body:JSON.stringify(data)}); 
                alert(`User ${un} berhasil diaktivasi!`); 
                load();
            } catch (e) { alert("Gagal update."); }
        }
        load();
    </script>
</body>
</html>